<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Custom Invoice Generator</title>

  <!-- Bootstrap CSS & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- SheetJS, jsPDF + AutoTable, JSZip, FileSaver -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.27/dist/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.0/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    body { padding-top: 4rem; background: #f8f9fa; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="container d-flex justify-content-center">
    <div class="w-50" style="max-width:600px;">

      <!-- Unlock Page -->
      <div id="unlockPage" class="card shadow-sm mb-4">
        <div class="card-body p-4 text-center">
          <h1 class="card-title mb-4">Enter Unlock Code</h1>
          <input type="text" id="unlockInput" class="form-control mb-3" placeholder="Enter unlock code">
          <button id="unlockBtn" class="btn btn-primary w-100 mb-3">Unlock</button>
          <div id="unlockAlert"></div>

          <div class="mt-3 d-flex justify-content-center gap-3">
            <a href="YOUTUBE_URL" target="_blank" class="d-flex align-items-center text-decoration-none">
              <i class="bi bi-youtube fs-4 text-danger"></i><span class="ms-2">See instructions</span>
            </a>
            <a href="https://wa.me/8801610926927" target="_blank" class="d-flex align-items-center text-decoration-none">
              <i class="bi bi-whatsapp fs-4 text-success"></i><span class="ms-2">Contact us</span>
            </a>
          </div>

          <div class="accordion mt-4" id="unlockInfoAccordion">
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingUnlockInfo">
                <button class="accordion-button collapsed" type="button"
                  data-bs-toggle="collapse" data-bs-target="#collapseUnlockInfo"
                  aria-expanded="false" aria-controls="collapseUnlockInfo">
                  How to get Unlock Code?
                </button>
              </h2>
              <div id="collapseUnlockInfo" class="accordion-collapse collapse"
                   aria-labelledby="headingUnlockInfo" data-bs-parent="#unlockInfoAccordion">
                <div class="accordion-body text-start">
                  এক্টিভেশন কোড পেতে ০১৬১০৯২৬৯২৭ নম্বরে বিকাশের মাধ্যমে ১৯৯ টাকা সেন্ড মানি করুন।
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Generator Page -->
      <div id="generatorPage" class="hidden">
        <div class="card shadow-sm mb-4">
          <div class="card-body p-4">
            <h1 class="card-title text-center mb-4">Invoice Generator</h1>

            <!-- Paper Size -->
            <div class="mb-3 row">
              <label class="col-sm-4 col-form-label">Paper Size</label>
              <div class="col-sm-8">
                <select id="presetSize" class="form-select">
                  <option value="210,297,mm">A4 Portrait</option>
                  <option value="210,148.5,mm">Half A4 Portrait</option>
                </select>
              </div>
            </div>

            <!-- Optional Date -->
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="showDate" checked>
              <label class="form-check-label" for="showDate">Print Invoice Date</label>
            </div>

            <!-- Inputs -->
            <div class="mb-2">
              <label class="form-label">Upload Font (.ttf/.otf)</label>
              <input type="file" id="fontInput" class="form-control" accept=".ttf,.otf">
            </div>
            <div class="mb-2">
              <label class="form-label">Upload Logo</label>
              <input type="file" id="headerInput" class="form-control" accept="image/*">
            </div>
            <div class="mb-2">
              <label class="form-label">Footer Text (optional)</label>
              <textarea id="footerText" class="form-control" rows="2"
                placeholder="Enter footer text (use / for line breaks)"></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label">Footer QR/Image (optional)</label>
              <input type="file" id="footerInput" class="form-control" accept="image/*">
            </div>
            <div class="mb-2">
              <label class="form-label">Excel File (template)</label>
              <input type="file" id="excelInput" class="form-control" accept=".xls,.xlsx">
            </div>
            <div id="invoiceSelection" class="mb-2 hidden">
              <label class="form-label">Select Invoices</label>
              <select id="invoiceSelect" class="form-select" multiple size="8"></select>
            </div>
            <button type="button" id="generateBtn" class="btn btn-primary w-100 mt-2">
              Generate Invoices
            </button>
            <div id="alertPlaceholder" class="mt-3"></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Main Logic -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const { jsPDF } = window.jspdf;

    // 1) Unlock
    document.getElementById('unlockBtn').addEventListener('click', async () => {
      const code = document.getElementById('unlockInput').value.trim();
      const alertEl = document.getElementById('unlockAlert');
      alertEl.innerHTML = '';
      try {
        const resp = await fetch('https://raw.githubusercontent.com/nasimulhasan/invoicegenerator/main/keys.json');
        if (!resp.ok) throw new Error();
        const { validCodes } = await resp.json();
        if (validCodes.includes(code)) {
          document.getElementById('unlockPage').classList.add('hidden');
          document.getElementById('generatorPage').classList.remove('hidden');
        } else {
          alertEl.innerHTML = '<div class="alert alert-warning">Invalid code</div>';
        }
      } catch {
        alertEl.innerHTML = '<div class="alert alert-danger">Error verifying code</div>';
      }
    });

    // 2) Parse Excel & Populate
    let parsedRows = [];
    document.getElementById('excelInput').addEventListener('change', async e => {
      const file = e.target.files[0]; if (!file) return;
      const arr = await new Response(file).arrayBuffer();
      const wb  = XLSX.read(arr, { type: 'array' });
      parsedRows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: '' });

      const invoices = [...new Set(parsedRows.map(r => (r.Invoice||'').trim()))];
      const sel = document.getElementById('invoiceSelect');
      sel.innerHTML = '';
      invoices.forEach(inv => sel.append(new Option(inv, inv)));
      document.getElementById('invoiceSelection').classList.remove('hidden');
    });

    // 3) Load custom font
    let customFontName, customFontData;
    document.getElementById('fontInput').addEventListener('change', async e => {
      const f = e.target.files[0]; if (!f) return;
      const url = await new Promise(res => {
        const r = new FileReader(); r.onload = ()=>res(r.result); r.readAsDataURL(f);
      });
      customFontName = f.name;
      customFontData = url.split(',')[1];
    });

    // 4) Utility to read image
    const loadImage = file => new Promise(res => {
      if (!file) return res(null);
      const r = new FileReader(); r.onload = ()=>res(r.result); r.readAsDataURL(file);
    });

    // 5) Generate Invoices
    document.getElementById('generateBtn').addEventListener('click', async () => {
      const headerFile = document.getElementById('headerInput').files[0];
      const footerFile = document.getElementById('footerInput').files[0];
      const footerText = document.getElementById('footerText').value.trim();
      const showDate = document.getElementById('showDate').checked;
      if (!headerFile) return alert('Please upload a logo.');
      if (!parsedRows.length) return alert('Please upload and parse an Excel file.');

      const headerData = await loadImage(headerFile);
      const footerData = await loadImage(footerFile);

      // determine page size
      let [w,h,unit] = document.getElementById('presetSize').value.split(',');
      w = +w; h = +h; // unit remains 'mm'

      // group by invoice
      const selected = Array.from(document.getElementById('invoiceSelect')
                        .selectedOptions).map(o=>o.value);
      const targets = selected.length ? selected
        : [...new Set(parsedRows.map(r=>r.Invoice.trim()))];

      const zip = new JSZip();
      for (const inv of targets) {
        const rows = parsedRows.filter(r=>r.Invoice.trim()===inv);
        if (!rows.length) continue;

        const doc = new jsPDF({ unit, format: [w, h] });
        // embed custom font
        if (customFontName) {
          doc.addFileToVFS(customFontName, customFontData);
          doc.addFont(customFontName, 'CustomFont', 'normal');
          doc.setFont('CustomFont');
        } else {
          doc.setFont('helvetica');
        }

        const pad = 10;
        let y = pad;

        // HEADER: logo left, shop details right, same Y
let headerY = pad;

// draw logo if present
let logoH = 0;
if (headerData) {
  const props = doc.getImageProperties(headerData);
  const maxH  = 30; // mm
  logoH = Math.min(maxH, w * (props.height / props.width));
  const logoW = logoH * (props.width / props.height);
  doc.addImage(headerData, 'PNG', pad, headerY, logoW, logoH);
}

// draw shop details on same baseline, right‑aligned
const shopName    = rows[0]['Shop Name']    || '';
const shopAddress = rows[0]['Shop Address'] || '';
doc.setFontSize(14);
doc.text(shopName, w - pad, headerY + 4, { align: 'right' });
doc.setFontSize(10);
// split address lines, draw starting slightly below the shop name
const addrLines = doc.splitTextToSize(shopAddress, w - 2*pad - (logoH ? (logoH * (doc.getImageProperties(headerData).width / doc.getImageProperties(headerData).height) + 10) : 0));
doc.text(addrLines, w - pad, headerY + 10, { align: 'right' });

// advance Y past whichever is taller: logo or shop‑header block
const shopBlockH = 10 + addrLines.length * 6;
y = headerY + Math.max(logoH, shopBlockH) + 6;


        // optional date
        if (showDate) {
          doc.setFontSize(10);
          const ds = new Date().toLocaleDateString();
          doc.text(`Date: ${ds}`, pad, y);
          y += 8;
        }

        // logo
        if (headerData) {
          const props = doc.getImageProperties(headerData);
          const maxH  = 30;
          const imgH  = Math.min(maxH, w * (props.height / props.width));
          const imgW  = imgH * (props.width / props.height);
          doc.addImage(headerData, 'PNG', pad, y, imgW, imgH);
          y += imgH + 6;
        }

        // build and draw table
        const body = rows.map(r => {
          const qty   = parseInt(r.Quantity)||0;
          const price = parseFloat(r.Price)||0;
          const lineTotal = qty*price;
          return [
            (r.Items||'').replace(/\//g, '\n'),
            qty, price.toFixed(2), lineTotal.toFixed(2)
          ];
        });
        doc.autoTable({
          head: [['Item','Qty','Price','Line Total']],
          body,
          startY: y,
          theme: 'grid',
          styles: { lineWidth: 0.2 },
          headStyles: { lineWidth: 0.8 },
          columnStyles: {
            0: { cellWidth: w - 2*pad - 120 },
            1: { halign: 'right' },
            2: { halign: 'right' },
            3: { halign: 'right' }
          }
        });
        y = doc.lastAutoTable.finalY + 4;

        // totals
        const subTotal = body.reduce((s,row)=>s + parseFloat(row[3]), 0);
        const discount = parseFloat(rows[0].Discount)||0;
        const grand    = subTotal - discount;
        doc.setFontSize(10);
        doc.text(`Subtotal:`, pad, y);           doc.text(subTotal.toFixed(2), w-pad, y, { align:'right' }); y+=6;
        doc.text(`Discount:`, pad, y);           doc.text(discount.toFixed(2), w-pad, y, { align:'right' }); y+=6;
        doc.text(`Grand Total:`, pad, y);        doc.text(grand.toFixed(2), w-pad, y, { align:'right' }); y+=10;

        // footer text
        if (footerText) {
          doc.setFontSize(8);
          doc.text(footerText, pad, h - pad - (footerData?30:0), { maxWidth: w-2*pad });
        }
        // footer image
        // footer image (max 1.5″ × 1.5″)
if (footerData) {
  const props = doc.getImageProperties(footerData);
  const maxDim = 1.5 * 25.4; // 1.5 inches in mm

  // preserve aspect ratio
  const aspect = props.width / props.height;
  let imgW = maxDim;
  let imgH = maxDim;
  if (aspect > 1) {
    // landscape
    imgH = maxDim / aspect;
  } else {
    // portrait or square
    imgW = maxDim * aspect;
  }

  // draw at bottom‑left with padding
  doc.addImage(
    footerData,
    'PNG',
    pad,
    h - pad - imgH,
    imgW,
    imgH
  );
}


        zip.file(`${inv}.pdf`, doc.output('blob'));
      }

      const blob = await zip.generateAsync({ type:'blob' });
      saveAs(blob, 'invoices.zip');
    });

  });
  </script>
</body>
</html>
