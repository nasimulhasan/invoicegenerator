<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Custom Invoice Generator</title>

  <!-- Bootstrap CSS & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- SheetJS, jsPDF + AutoTable, JSZip, FileSaver -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.27/dist/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.0/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    body { padding-top: 4rem; background: #f8f9fa; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="container d-flex justify-content-center">
    <div class="w-50" style="max-width:600px;">

      <!-- Unlock Page -->
      <div id="unlockPage" class="card shadow-sm mb-4">
        <div class="card-body p-4 text-center">
          <h1 class="card-title mb-4">Enter Unlock Code</h1>
          <input type="text" id="unlockInput" class="form-control mb-3" placeholder="Enter unlock code">
          <button id="unlockBtn" class="btn btn-primary w-100 mb-3">Unlock</button>
          <div id="unlockAlert"></div>
          <div class="mt-3 d-flex justify-content-center gap-3">
            <a href="YOUTUBE_URL" target="_blank" class="d-flex align-items-center text-decoration-none">
              <i class="bi bi-youtube fs-4 text-danger"></i><span class="ms-2">See instructions</span>
            </a>
            <a href="https://wa.me/8801610926927" target="_blank" class="d-flex align-items-center text-decoration-none">
              <i class="bi bi-whatsapp fs-4 text-success"></i><span class="ms-2">Contact us</span>
            </a>
          </div>
          <div class="accordion mt-4" id="unlockInfoAccordion">
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingUnlockInfo">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUnlockInfo" aria-expanded="false" aria-controls="collapseUnlockInfo">
                  How to get Unlock Code?
                </button>
              </h2>
              <div id="collapseUnlockInfo" class="accordion-collapse collapse" aria-labelledby="headingUnlockInfo" data-bs-parent="#unlockInfoAccordion">
                <div class="accordion-body text-start">
                  এক্টিভেশন কোড পেতে ০১৬১০৯২৬৯২৭ নম্বরে বিকাশের মাধ্যমে ১৯৯ টাকা সেন্ড মানি করুন।
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Generator Page -->
      <div id="generatorPage" class="hidden">
        <div class="card shadow-sm mb-4">
          <div class="card-body p-4">
            <h1 class="card-title text-center mb-4">Invoice Generator</h1>
            <div class="mb-3 row">
              <label class="col-sm-4 col-form-label">Paper Size</label>
              <div class="col-sm-8">
                <select id="presetSize" class="form-select">
                  <option value="210,297,mm">A4 Portrait</option>
                  <option value="210,148.5,mm">Half A4 Portrait</option>
                </select>
              </div>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="showDate" checked>
              <label class="form-check-label" for="showDate">Print Invoice Date</label>
            </div>
            <div class="mb-2">
              <label class="form-label">Upload Logo</label>
              <input type="file" id="headerInput" class="form-control" accept="image/*">
            </div>
            <div class="mb-2">
              <label class="form-label">Footer Text (optional)</label>
              <textarea id="footerText" class="form-control" rows="2" placeholder="Enter footer text (use / for line breaks)"></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label">Footer QR/Image (optional)</label>
              <input type="file" id="footerInput" class="form-control" accept="image/*">
            </div>
            <div class="mb-2">
              <label class="form-label">Excel File (template)</label>
              <input type="file" id="excelInput" class="form-control" accept=".xls,.xlsx">
            </div>
            <div id="invoiceSelection" class="mb-2 hidden">
              <label class="form-label">Select Invoices</label>
              <select id="invoiceSelect" class="form-select" multiple size="8"></select>
            </div>
            <button type="button" id="generateBtn" class="btn btn-primary w-100 mt-2">Generate Invoices</button>
            <div id="alertPlaceholder" class="mt-3"></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const { jsPDF } = window.jspdf;

  const unlockBtn = document.getElementById('unlockBtn');
  const generateBtn = document.getElementById('generateBtn');
  const alertPlaceholder = document.getElementById('alertPlaceholder');

  const showAlert = (message, type = 'danger') => {
    alertPlaceholder.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
  };

  const loadImage = file => new Promise((resolve, reject) => {
    if (!file) return resolve(null);
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
    reader.readAsDataURL(file);
  });

  unlockBtn.addEventListener('click', async () => {
    const code = document.getElementById('unlockInput').value.trim();
    const alertEl = document.getElementById('unlockAlert');
    alertEl.innerHTML = '';
    unlockBtn.disabled = true;
    try {
      const resp = await fetch('https://raw.githubusercontent.com/nasimulhasan/invoicegenerator/main/keys.json');
      if (!resp.ok) throw new Error('Network response was not ok.');
      const { validCodes } = await resp.json();
      if (validCodes && validCodes.includes(code)) {
        document.getElementById('unlockPage').classList.add('hidden');
        document.getElementById('generatorPage').classList.remove('hidden');
      } else {
        alertEl.innerHTML = '<div class="alert alert-warning">Invalid code. Please try again.</div>';
      }
    } catch(err) {
      console.error("Unlock Error:", err);
      alertEl.innerHTML = '<div class="alert alert-danger">Error verifying code. Check your internet connection.</div>';
    } finally {
      unlockBtn.disabled = false;
    }
  });

  document.getElementById('excelInput').addEventListener('change', async e => {
    const file = e.target.files[0];
    const invoiceSelectionDiv = document.getElementById('invoiceSelection');
    const invoiceSelect = document.getElementById('invoiceSelect');
    invoiceSelectionDiv.classList.add('hidden');
    invoiceSelect.innerHTML = '';
    alertPlaceholder.innerHTML = '';
    if (!file) return;
    try {
      const data = await file.arrayBuffer();
      const workbook = XLSX.read(data, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      const jsonRows = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
      window.parsedRows = jsonRows;
      const invoiceNumbers = [...new Set(jsonRows.map(r => (r.Invoice || '').toString().trim()).filter(Boolean))];
      if (invoiceNumbers.length > 0) {
        invoiceNumbers.forEach(inv => {
          const option = new Option(inv, inv);
          invoiceSelect.append(option);
        });
        invoiceSelectionDiv.classList.remove('hidden');
      } else {
        showAlert('No invoices found in the Excel file. Make sure there is an "Invoice" column.', 'warning');
        window.parsedRows = [];
      }
    } catch (err) {
      console.error("Excel Parsing Error:", err);
      showAlert('There was an error reading the Excel file.', 'danger');
      window.parsedRows = [];
    }
  });

  generateBtn.addEventListener('click', async () => {
    alertPlaceholder.innerHTML = ''; 
    const { parsedRows } = window;
    if (!parsedRows || parsedRows.length === 0) {
      return showAlert('Please upload a valid Excel file first.', 'warning');
    }
    if (!document.getElementById('headerInput').files[0]) {
      return showAlert('Please upload a logo image for the header.', 'warning');
    }

    generateBtn.disabled = true;
    generateBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...`;

    try {
      const headerFile = document.getElementById('headerInput').files[0];
      const footerFile = document.getElementById('footerInput').files[0];
      const footerText = document.getElementById('footerText').value.trim();
      const showDate = document.getElementById('showDate').checked;
      const [headerData, footerData] = await Promise.all([loadImage(headerFile), loadImage(footerFile)]);
      let [w, h, unit] = document.getElementById('presetSize').value.split(',');
      w = +w; h = +h;
      const selectedOptions = Array.from(document.getElementById('invoiceSelect').selectedOptions).map(o => o.value);
      const allInvoices = [...new Set(parsedRows.map(r => r.Invoice.toString().trim()))];
      const targetInvoices = selectedOptions.length ? selectedOptions : allInvoices;
      const zip = new JSZip();

      for (const inv of targetInvoices) {
        const doc = new jsPDF({ unit, format: [w, h] });
        const rows = parsedRows.filter(r => r.Invoice.toString().trim() === inv);
        if (rows.length === 0) continue;

        const firstRow = rows[0];
        doc.setFont('helvetica');
        const pad = 10;
        let y = pad;

        // --- Header: Logo and Shop Details ---
        let logoH = 0;
        if (headerData) {
          const p = doc.getImageProperties(headerData);
          const maxH = 30;
          const logoAspectRatio = p.width / p.height;
          logoH = Math.min(maxH, w * (1 / logoAspectRatio));
          const logoW = logoH * logoAspectRatio;
          doc.addImage(headerData, 'PNG', pad, y, logoW, logoH);
        }
        
        // ======================= MODIFICATION START (Shop Address) =========================
        const shopName = firstRow['Shop Name'] || '';
        const shopAddress = firstRow['Shop Address'] || '';
        const shopAddressMaxWidth = (w - pad * 2) - (logoH > 0 ? (logoH * (doc.getImageProperties(headerData).width / doc.getImageProperties(headerData).height) + 5) : 0);
        
        doc.setFontSize(14).text(shopName, w - pad, y + 4, { align: 'right' });
        doc.setFontSize(10);
        const addrLines = doc.splitTextToSize(shopAddress, shopAddressMaxWidth);
        doc.text(addrLines, w - pad, y + 10, { align: 'right' });
        y += Math.max(logoH, 10 + addrLines.length * 5) + 10;
        // ======================= MODIFICATION END =========================

        // "INVOICE" Title
        doc.setFontSize(22).setFont(undefined, 'bold');
        doc.text('INVOICE', w / 2, y, { align: 'center' });
        doc.setFont(undefined, 'normal');
        y += 15;
        
        // --- Customer Details and Date ---
        const firstName = (firstRow['First Name'] || '').toString().trim();
        const lastName = (firstRow['Last Name'] || '').toString().trim();
        const customerPhone = (firstRow['Phone'] || '').toString().trim();
        const customerAddress = (firstRow['Address'] || '').toString().trim();
        const fullName = [firstName, lastName].filter(Boolean).join(' ');
        
        doc.setFontSize(10).setFont(undefined, 'bold');
        doc.text('Bill To:', pad, y);
        doc.setFont(undefined, 'normal');
        
        let customerInfo = [];
        if (fullName) customerInfo.push(fullName);
        if (customerPhone) customerInfo.push(`Phone: ${customerPhone}`);
        if (customerAddress) customerInfo.push(...doc.splitTextToSize(customerAddress, w/2 - pad));
        
        doc.text(customerInfo, pad, y + 5);

        if (showDate) {
          doc.setFontSize(10).text(`Date: ${new Date().toLocaleDateString()}`, w - pad, y, { align: 'right' });
        }
        
        y += (customerInfo.length * 5) + 10;

        // --- Table ---
        const body = rows.map(r => {
          const qty = parseInt(r.Quantity) || 0;
          const price = parseFloat(r.Price) || 0;
          return [ (r.Items || '').replace(/\//g, '\n'), qty.toString(), price.toFixed(2), (qty * price).toFixed(2) ];
        });
        const subTotal = body.reduce((sum, row) => sum + parseFloat(row[3]), 0);
        const discount = parseFloat(firstRow.Discount) || 0;
        const grandTotal = subTotal - discount;

        body.push(
          ['', '', 'Subtotal', subTotal.toFixed(2)],
          ['', '', 'Discount', discount.toFixed(2)],
          ['', '', 'Grand Total', grandTotal.toFixed(2)]
        );

        doc.autoTable({
          head: [['Item', 'Qty', 'Price', 'Line Total']],
          body: body,
          startY: y,
          theme: 'grid',
          styles: { cellPadding: 2, fontSize: 10 },
          headStyles: { fillColor: [220, 220, 220], textColor: 0, fontStyle: 'bold' },
          columnStyles: { 
            0: { cellWidth: 'auto' },
            1: { halign: 'center' },
            2: { halign: 'right' },
            3: { halign: 'right' }
          },
          didParseCell: (data) => {
            const isSummaryRow = ['Subtotal', 'Discount', 'Grand Total'].includes(data.row.raw[2]);
            if (data.section === 'body' && isSummaryRow) {
              data.cell.styles.fontStyle = 'bold';
            }
          }
        });

        // ======================= MODIFICATION START (Footer Image) =========================
        // --- Footer ---
        const finalY = doc.autoTable.previous.finalY;
        // Ensure footer start position is always within the page
        const footerStartY = Math.min(h - 40, Math.max(finalY + 15, h - 40));

        if (footerText) {
          doc.setFontSize(8);
          const textLines = doc.splitTextToSize(footerText.replace(/\//g, '\n'), (w - 2 * pad) / 2);
          doc.text(textLines, pad, footerStartY);
        }
        if (footerData) {
          const p = doc.getImageProperties(footerData);
          // Make max image dimensions relative to page width
          const maxDim = w * 0.15; // e.g., max 15% of page width
          const aspect = p.width / p.height;
          let imgW = maxDim, imgH = maxDim;
          if (aspect > 1) { imgH = maxDim / aspect; } else { imgW = maxDim * aspect; }
          // Position the image at the bottom right corner
          doc.addImage(footerData, 'PNG', w - pad - imgW, h - pad - imgH, imgW, imgH);
        }
        // ======================== MODIFICATION END ==========================
        zip.file(`${inv}.pdf`, doc.output('blob'));
      }

      if (Object.keys(zip.files).length > 0) {
        const blob = await zip.generateAsync({ type: 'blob' });
        saveAs(blob, 'invoices.zip');
        showAlert('Successfully generated invoices.zip!', 'success');
      } else {
        showAlert('No invoices were selected or found to generate.', 'warning');
      }
    } catch (err) {
      console.error("PDF Generation Error:", err);
      showAlert(`An error occurred during PDF generation: ${err.message}`, 'danger');
    } finally {
      generateBtn.disabled = false;
      generateBtn.innerText = 'Generate Invoices';
    }
  });
});
</script>

</body>
</html>
